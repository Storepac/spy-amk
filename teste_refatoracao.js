/**
 * Teste de Refatora√ß√£o - Verifica se todos os componentes est√£o funcionando
 */
class TesteRefatoracao {
    static executarTestes() {
        console.log('üß™ Iniciando testes de refatora√ß√£o...');
        
        const resultados = {
            componentes: this.testarComponentes(),
            funcionalidades: this.testarFuncionalidades(),
            performance: this.testarPerformance(),
            integracao: this.testarIntegracao()
        };
        
        this.exibirResultados(resultados);
        return resultados;
    }

    static testarComponentes() {
        const testes = {
            'Constants': typeof Constants !== 'undefined',
            'Helpers': typeof Helpers !== 'undefined',
            'ModalBuilder': typeof ModalBuilder !== 'undefined',
            'TableRowBuilder': typeof TableRowBuilder !== 'undefined',
            'FilterManager': typeof FilterManager !== 'undefined',
            'EventManager': typeof EventManager !== 'undefined',
            'TableManager': typeof TableManager !== 'undefined'
        };

        const sucessos = Object.values(testes).filter(Boolean).length;
        const total = Object.keys(testes).length;

        return {
            testes,
            sucessos,
            total,
            percentual: (sucessos / total) * 100
        };
    }

    static testarFuncionalidades() {
        const testes = {};

        // Teste de formata√ß√£o
        try {
            const moeda = Helpers.formatarMoeda(1234.56);
            testes['Formata√ß√£o de moeda'] = moeda === 'R$ 1.234,56';
        } catch (error) {
            testes['Formata√ß√£o de moeda'] = false;
        }

        // Teste de valida√ß√£o ASIN
        try {
            testes['Valida√ß√£o ASIN v√°lido'] = Helpers.validarASIN('B08N5WRWNW');
            testes['Valida√ß√£o ASIN inv√°lido'] = !Helpers.validarASIN('INVALID');
        } catch (error) {
            testes['Valida√ß√£o ASIN'] = false;
        }

        // Teste de extra√ß√£o de n√∫mero
        try {
            testes['Extra√ß√£o de n√∫mero'] = Helpers.extrairNumero('R$ 123,45') === 123.45;
        } catch (error) {
            testes['Extra√ß√£o de n√∫mero'] = false;
        }

        // Teste de truncamento
        try {
            testes['Truncamento de texto'] = Helpers.truncarTexto('Texto muito longo', 10) === 'Texto mui...';
        } catch (error) {
            testes['Truncamento de texto'] = false;
        }

        const sucessos = Object.values(testes).filter(Boolean).length;
        const total = Object.keys(testes).length;

        return {
            testes,
            sucessos,
            total,
            percentual: (sucessos / total) * 100
        };
    }

    static testarPerformance() {
        const testes = {};

        // Teste de debounce
        try {
            const debouncedFn = Helpers.debounce(() => {}, 100);
            testes['Debounce'] = typeof debouncedFn === 'function';
        } catch (error) {
            testes['Debounce'] = false;
        }

        // Teste de throttle
        try {
            const throttledFn = Helpers.throttle(() => {}, 100);
            testes['Throttle'] = typeof throttledFn === 'function';
        } catch (error) {
            testes['Throttle'] = false;
        }

        // Teste de gera√ß√£o de ID
        try {
            const id1 = Helpers.gerarId();
            const id2 = Helpers.gerarId();
            testes['Gera√ß√£o de ID √∫nico'] = id1 !== id2 && id1.length > 0;
        } catch (error) {
            testes['Gera√ß√£o de ID √∫nico'] = false;
        }

        const sucessos = Object.values(testes).filter(Boolean).length;
        const total = Object.keys(testes).length;

        return {
            testes,
            sucessos,
            total,
            percentual: (sucessos / total) * 100
        };
    }

    static testarIntegracao() {
        const testes = {};

        // Teste de verifica√ß√£o de componentes
        try {
            testes['Verifica√ß√£o de componentes'] = typeof TableManager.verificarComponentes === 'function';
        } catch (error) {
            testes['Verifica√ß√£o de componentes'] = false;
        }

        // Teste de cria√ß√£o de modal
        try {
            const produtosTeste = [
                {
                    titulo: 'Produto Teste',
                    asin: 'B08N5WRWNW',
                    preco: 'R$ 100,00',
                    precoNumerico: 100,
                    avaliacao: '4.5',
                    avaliacaoNumerica: 4.5,
                    vendidos: 1000,
                    ranking: '500',
                    marca: 'Marca Teste',
                    patrocinado: false,
                    organico: true
                }
            ];

            const modalHTML = ModalBuilder.criarModalPrincipal(produtosTeste, {}, 'teste');
            testes['Cria√ß√£o de modal'] = modalHTML.includes('amazon-analyzer-modal');
        } catch (error) {
            testes['Cria√ß√£o de modal'] = false;
        }

        // Teste de cria√ß√£o de linha
        try {
            const produto = {
                titulo: 'Produto Teste',
                asin: 'B08N5WRWNW',
                preco: 'R$ 100,00',
                precoNumerico: 100,
                avaliacao: '4.5',
                avaliacaoNumerica: 4.5,
                vendidos: 1000,
                ranking: '500',
                marca: 'Marca Teste',
                patrocinado: false,
                organico: true
            };

            const linhaHTML = TableRowBuilder.criarLinhaProduto(produto, 0);
            testes['Cria√ß√£o de linha'] = linhaHTML.includes('data-asin="B08N5WRWNW"');
        } catch (error) {
            testes['Cria√ß√£o de linha'] = false;
        }

        const sucessos = Object.values(testes).filter(Boolean).length;
        const total = Object.keys(testes).length;

        return {
            testes,
            sucessos,
            total,
            percentual: (sucessos / total) * 100
        };
    }

    static exibirResultados(resultados) {
        console.log('\nüìä RESULTADOS DOS TESTES DE REFATORA√á√ÉO');
        console.log('=====================================\n');

        Object.entries(resultados).forEach(([categoria, resultado]) => {
            console.log(`\nüîç ${categoria.toUpperCase()}:`);
            console.log(`   Sucessos: ${resultado.sucessos}/${resultado.total} (${resultado.percentual.toFixed(1)}%)`);
            
            Object.entries(resultado.testes).forEach(([teste, sucesso]) => {
                const status = sucesso ? '‚úÖ' : '‚ùå';
                console.log(`   ${status} ${teste}`);
            });
        });

        const totalSucessos = Object.values(resultados).reduce((sum, r) => sum + r.sucessos, 0);
        const totalTestes = Object.values(resultados).reduce((sum, r) => sum + r.total, 0);
        const percentualGeral = (totalSucessos / totalTestes) * 100;

        console.log('\nüéØ RESUMO GERAL:');
        console.log(`   Total de testes: ${totalTestes}`);
        console.log(`   Sucessos: ${totalSucessos}`);
        console.log(`   Taxa de sucesso: ${percentualGeral.toFixed(1)}%`);

        if (percentualGeral >= 90) {
            console.log('\nüéâ REFATORA√á√ÉO SUCESSO! Sistema pronto para uso.');
        } else if (percentualGeral >= 70) {
            console.log('\n‚ö†Ô∏è REFATORA√á√ÉO PARCIAL. Alguns ajustes necess√°rios.');
        } else {
            console.log('\n‚ùå REFATORA√á√ÉO COM PROBLEMAS. Revis√£o necess√°ria.');
        }
    }

    static testarCenariosReais() {
        console.log('\nüß™ Testando cen√°rios reais...');

        // Cen√°rio 1: Cria√ß√£o completa do sistema
        try {
            const produtos = [
                {
                    titulo: 'Produto 1',
                    asin: 'B08N5WRWNW',
                    preco: 'R$ 100,00',
                    precoNumerico: 100,
                    avaliacao: '4.5',
                    avaliacaoNumerica: 4.5,
                    vendidos: 1000,
                    ranking: '500',
                    marca: 'Marca A',
                    patrocinado: true,
                    organico: false
                },
                {
                    titulo: 'Produto 2',
                    asin: 'B08N5WRWNW', // ASIN duplicado
                    preco: 'R$ 200,00',
                    precoNumerico: 200,
                    avaliacao: '4.0',
                    avaliacaoNumerica: 4.0,
                    vendidos: 500,
                    ranking: '1000',
                    marca: 'Marca B',
                    patrocinado: false,
                    organico: true
                }
            ];

            // Simular cria√ß√£o da tabela
            const metricas = ProductAnalyzer.calcularMetricas(produtos);
            const modalHTML = ModalBuilder.criarModalPrincipal(produtos, metricas, 'teste');
            
            console.log('‚úÖ Cen√°rio 1: Cria√ß√£o do sistema - SUCESSO');
            console.log(`   Produtos processados: ${produtos.length}`);
            console.log(`   Modal criado: ${modalHTML.length} caracteres`);
            
        } catch (error) {
            console.log('‚ùå Cen√°rio 1: Cria√ß√£o do sistema - FALHOU');
            console.error('   Erro:', error.message);
        }

        // Cen√°rio 2: Filtros
        try {
            const filterManager = new FilterManager();
            filterManager.setProdutos([
                {
                    titulo: 'Produto Teste',
                    precoNumerico: 150,
                    avaliacaoNumerica: 4.5,
                    marca: 'Marca Teste',
                    vendidos: 1000,
                    ranking: '500',
                    patrocinado: true,
                    organico: false
                }
            ]);

            console.log('‚úÖ Cen√°rio 2: Sistema de filtros - SUCESSO');
            console.log(`   Marcas √∫nicas: ${filterManager.marcasUnicas.length}`);
            
        } catch (error) {
            console.log('‚ùå Cen√°rio 2: Sistema de filtros - FALHOU');
            console.error('   Erro:', error.message);
        }

        // Cen√°rio 3: Eventos
        try {
            const eventManager = new EventManager();
            console.log('‚úÖ Cen√°rio 3: Sistema de eventos - SUCESSO');
            
        } catch (error) {
            console.log('‚ùå Cen√°rio 3: Sistema de eventos - FALHOU');
            console.error('   Erro:', error.message);
        }
    }
}

// Executar testes automaticamente se estiver no console
if (typeof window !== 'undefined') {
    window.TesteRefatoracao = TesteRefatoracao;
    
    // Executar ap√≥s carregamento completo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => TesteRefatoracao.executarTestes(), 1000);
        });
    } else {
        setTimeout(() => TesteRefatoracao.executarTestes(), 1000);
    }
} 